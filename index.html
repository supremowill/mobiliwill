<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solicitar Corrida ‚Ä¢ Maring√° PR</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    :root {
      --bg:#0b0f12; --panel:#111820; --panel-2:#0f141a; --ink:#e9eef3;
      --muted:#9fb0bf; --brand:#34c759; --brand-2:#2bb44f; --danger:#ff5252;
      --stroke:#1f2933; --accent:#1b2836;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
    }
    
    body {
      margin: 0;
      background: linear-gradient(180deg, #0b0f12, #0b0f12 40%, #0c1218);
      color: var(--ink);
      font: 500 clamp(14px, 2.4vw, 16px)/1.4 system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu;
    }
    
    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: clamp(12px, 3vw, 20px);
    }
    
    header {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-bottom: 14px;
    }
    
    .logo {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: radial-gradient(100% 100% at 10% 10%, #1a2a3a, #0c141d);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px #000 inset, 0 20px 50px rgba(0,0,0,.4);
    }
    
    .logo svg {
      opacity: .92;
    }
    
    header h1 {
      font-size: clamp(16px, 3.8vw, 20px);
      margin: 0;
    }
    
    header .sub {
      color: var(--muted);
      font-size: clamp(11px, 2.2vw, 12px);
      margin-top: 2px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 16px;
    }
    
    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: clamp(12px, 3vw, 16px);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    
    .row {
      display: grid;
      gap: 12px;
    }
    
    .pair {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .field {
      display: grid;
      gap: 8px;
    }
    
    label {
      font-size: 13px;
      color: var(--muted);
    }
    
    input, textarea, button, select {
      width: 100%;
      background: var(--accent);
      color: var(--ink);
      border: 1px solid #243240;
      border-radius: 10px;
      padding: 12px;
      outline: none;
      font-size: 16px; /* Evita zoom no iOS */
      min-height: 44px; /* Toque adequado */
      touch-action: manipulation;
    }
    
    input:focus, textarea:focus, button:focus, select:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.2);
    }
    
    input::placeholder, textarea::placeholder {
      color: #8096aa;
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    /* Datalist responsivo */
    datalist {
      max-height: 150px;
      overflow-y: auto;
    }
    
    .inline {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .btn {
      cursor: pointer;
      border: none;
      font-weight: 700;
      letter-spacing: .2px;
      transition: transform .06s, filter .15s, background .2s;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-primary {
      background: linear-gradient(180deg, var(--brand), var(--brand-2));
      color: #04120a;
    }
    
    .btn-ghost {
      background: #15212e;
      color: #d8e6f3;
      border: 1px solid #213142;
    }
    
    .btn-danger {
      background: var(--danger);
      color: #160606;
    }
    
    .btn-sm {
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      min-height: 44px;
    }
    
    .btn-lg {
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      min-height: 48px;
    }
    
    .hint {
      font-size: clamp(11px, 2.2vw, 12px);
      color: var(--muted);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #0e1620;
      border: 1px solid #1b2735;
      border-radius: 12px;
      color: #cfe3f5;
      font-size: clamp(12px, 2.5vw, 14px);
    }
    
    .kpis {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .kpi {
      display: grid;
      gap: 4px;
      padding: 10px 12px;
      background: #0f1822;
      border: 1px solid #1b2a3a;
      border-radius: 12px;
      min-width: 120px;
      flex: 1;
      min-width: 0;
    }
    
    .kpi small {
      color: #92aabf;
      font-size: clamp(10px, 2vw, 12px);
    }
    
    .kpi strong {
      font-size: clamp(14px, 3vw, 18px);
      white-space: nowrap;
    }
    
    #map {
      width: 100%;
      height: 560px;
      border-radius: 14px;
      overflow: hidden;
    }
    
    .footer {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #0e1a11;
      border: 1px solid #1f3b26;
      color: #b9f6c4;
      padding: 12px 14px;
      border-radius: 12px;
      display: none;
      z-index: 9999;
      max-width: calc(100vw - 32px);
      word-wrap: break-word;
    }
    
    .tarifas {
      font-size: clamp(12px, 2.3vw, 13px);
      color: #bcd1e4;
      background: #0e1620;
      border: 1px solid #1b2735;
      border-radius: 12px;
      padding: 10px 12px;
    }
    
    .pill {
      display: inline-block;
      margin-right: 6px;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #203042;
      background: #101a24;
      color: #dce9f5;
      font-size: clamp(10px, 2.1vw, 12px);
    }
    
    /* Responsividade - Tablet */
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      #map {
        height: 50vh;
        min-height: 300px;
      }
      
      .card {
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,.25);
      }
      
      .pair {
        gap: 8px;
      }
      
      .footer {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .footer .inline {
        justify-content: center;
      }
      
      .kpis {
        gap: 6px;
      }
      
      .kpi {
        min-width: calc(50% - 3px);
        padding: 8px 10px;
      }
    }
    
    /* Responsividade - Mobile */
    @media (max-width: 480px) {
      .shell {
        padding: 12px;
      }
      
      header {
        gap: 10px;
        margin-bottom: 12px;
      }
      
      .logo {
        width: 36px;
        height: 36px;
      }
      
      #map {
        height: 55vh;
        min-height: 280px;
        border-radius: 10px;
      }
      
      .card {
        padding: 10px;
        border-radius: 10px;
      }
      
      .row {
        gap: 10px;
      }
      
      .pair {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .field {
        gap: 6px;
      }
      
      input, textarea, button, select {
        padding: 14px 12px;
        border-radius: 8px;
      }
      
      .inline {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .footer .inline {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn-lg {
        padding: 16px 14px;
        font-size: 16px;
        min-height: 50px;
      }
      
      .kpis {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        display: grid;
      }
      
      .kpi {
        min-width: 0;
        padding: 8px;
      }
      
      .badge {
        text-align: center;
        justify-content: center;
      }
      
      .tarifas {
        padding: 8px 10px;
      }
      
      .pill {
        margin-right: 4px;
        margin-top: 4px;
        padding: 4px 8px;
      }
      
      .toast {
        right: 12px;
        bottom: 12px;
        max-width: calc(100vw - 24px);
      }
    }
    
    /* Ajustes espec√≠ficos para dispositivos touch */
    @media (hover: none) and (pointer: coarse) {
      .btn:hover {
        background: unset;
      }
      
      .btn:active {
        transform: scale(0.98);
      }
    }
    
    /* Contraste melhorado */
    @media (prefers-contrast: high) {
      :root {
        --stroke: #3a4a5a;
        --muted: #b0c0d0;
      }
    }
    
    /* Modo escuro for√ßado */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #000000;
        --panel: #0a0a0a;
      }
    }
    
    /* Estilos para controles do mapa em dispositivos m√≥veis */
    @media (max-width: 768px) {
      .mapboxgl-ctrl-group {
        margin-bottom: 10px !important;
        margin-right: 10px !important;
      }
      
      .mapboxgl-ctrl-group button {
        width: 44px !important;
        height: 44px !important;
        margin: 0 !important;
      }
      
      .mapboxgl-ctrl-bottom-right {
        bottom: 80px !important; /* Espa√ßo para n√£o sobrepor bot√µes */
      }
    }
    
    /* Performance otimizada */
    .card, .btn, .kpi {
      will-change: auto;
    }
    
    /* Estilos para feedback visual durante pesquisa */
    input.searching {
      border-color: #ffa500 !important;
      background: linear-gradient(90deg, var(--accent), #2a3a4a, var(--accent));
      background-size: 200% 100%;
      animation: searchPulse 1.5s ease-in-out infinite;
      position: relative;
    }
    
    input.searching::after {
      content: "üîç";
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      opacity: 0.7;
    }
    
    @keyframes searchPulse {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    /* Estados de sucesso e erro */
    input.success {
      border-color: #34c759 !important;
      background: var(--accent);
      animation: none;
    }
    
    input.error {
      border-color: #ff5252 !important;
      background: var(--accent);
      animation: none;
    }
    
    /* Melhorias no datalist */
    input::-webkit-calendar-picker-indicator {
      opacity: 0.6;
      cursor: pointer;
    }
    
    /* Sugest√µes no datalist */
    option[disabled] {
      color: #666 !important;
      font-style: italic;
    }
    
    /* Estilos para lista de sugest√µes melhorada */
    datalist {
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    /* Suporte a entrada de voz */
    input[type="text"], input[type="tel"] {
      -webkit-speech: continuous;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="logo" aria-hidden="true">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="#34c759"><path d="M12 2l3 7h7l-5.5 4.1L18.5 20 12 15.9 5.5 20 7.5 13.1 2 9h7l3-7z"/></svg>
      </div>
      <div>
        <h1>Solicitar Corrida ‚Äî Maring√°, PR</h1>
        <div class="sub">Dentro de Maring√°: R$ 2,00/km + R$ 0,50/min. Fora de Maring√°: R$ 3,00/km.</div>
      </div>
    </header>

    <div class="grid">
      <!-- Painel esquerdo -->
      <section class="card">
        <form id="rideForm" class="row" autocomplete="off">
          <div class="tarifas">
            <strong>Regras de pre√ßo:</strong>
            <div class="pill">üü¢ Dentro de Maring√°: R$ 2,00 por km + R$ 0,50 por minuto</div>
            <div class="pill">üîµ Fora de Maring√°: R$ 3,00 por km (sem minuto)</div>
            <div class="hint" style="margin-top:6px">Detec√ß√£o autom√°tica pelo endere√ßo. Se origem e destino estiverem em Maring√° aplica a tarifa interna. Qualquer destino fora muda para ‚Äúfora de Maring√°‚Äù.</div>
          </div>

          <div class="pair">
            <div class="field">
              <label for="nome">Nome</label>
              <input id="nome" name="nome" placeholder="Seu nome" required />
            </div>
            <div class="field">
              <label for="telefone">Telefone (WhatsApp)</label>
              <input id="telefone" name="telefone" inputmode="tel" autocomplete="tel" placeholder="(44) xxxxx-xxxx" />
            </div>
          </div>

          <div class="field">
            <label for="origem">Onde voc√™ est√°</label>
            <div class="inline">
              <input id="origem" name="origem" list="lista-origem" autocomplete="street-address" placeholder="Ex: Bosque, UEM, Centro, Zona 7..." required />
              <datalist id="lista-origem"></datalist>
              <button type="button" class="btn btn-sm btn-ghost" id="btnGeo">üìç Minha localiza√ß√£o</button>
            </div>
            <div class="hint">Digite refer√™ncias, endere√ßos ou pontos conhecidos de Maring√°.</div>
          </div>

          <div class="field">
            <label for="destino">Para onde vai</label>
            <input id="destino" name="destino" list="lista-destino" autocomplete="street-address" placeholder="Ex: Terminal, Catua√≠, HU, Aeroporto..." required />
            <datalist id="lista-destino"></datalist>
            <div class="hint">Refer√™ncias: Bosque, UEM, Centro, Terminal, HU, Santa Casa, Catedral.</div>
          </div>

          <div class="pair">
            <div class="field">
              <label for="quando">Hor√°rio desejado</label>
              <input id="quando" name="quando" type="datetime-local" required />
            </div>
            <div class="field">
              <label for="observacoes">Observa√ß√µes</label>
              <input id="observacoes" name="observacoes" placeholder="Portaria, bloco, quantidade de sacolas..." />
            </div>
          </div>

          <div class="kpis" id="kpis" hidden>
            <div class="kpi"><small>Dist√¢ncia</small><strong id="kpiDist">‚Äî</strong></div>
            <div class="kpi"><small>Dura√ß√£o</small><strong id="kpiTempo">‚Äî</strong></div>
            <div class="kpi"><small>Tipo</small><strong id="kpiTipo">‚Äî</strong></div>
            <div class="kpi"><small>Estimativa</small><strong id="kpiPreco">‚Äî</strong></div>
          </div>

        <div class="footer">
          <div class="badge" id="statusBadge" aria-live="polite">Pronto para tra√ßar rota.</div>
          <div class="inline">
            <button type="button" id="btnRota" class="btn btn-lg btn-ghost">Tra√ßar rota</button>
            <button type="submit" class="btn btn-lg btn-primary">Enviar pedido</button>
            <button type="button" id="btnLimpar" class="btn btn-lg btn-danger">Limpar</button>
          </div>
        </div>
        </form>
      </section>

      <!-- Mapa -->
      <section class="card">
        <div id="map" role="region" aria-label="Mapa com rota"></div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite"></div>

  <script>
    // ======= CONFIG: PREENCHA =======
    const MAPBOX_TOKEN    = "pk.eyJ1Ijoic3VwcmVtb3dpbGwiLCJhIjoiY21keHUydHM2MDEzYjJqcHMyNjlkbWVvbyJ9.FTzTaKQvyAZ3ihSNyAYFGg";
    const N8N_WEBHOOK_URL = "https://criadordigital-n8n-webhook.v05hji.easypanel.host/webhook/corrida";
    // ======= TARIFAS (Maring√°) ======
    const CIDADE_ALVO = "Maring√°";
    const PRECO_INTERNO_POR_KM = 2.00;  // dentro de Maring√°
    const PRECO_INTERNO_POR_MIN = 0.50; // dentro de Maring√°
    const PRECO_FORA_POR_KM = 3.00;     // fora de Maring√°
    // =================================

    mapboxgl.accessToken = MAPBOX_TOKEN;

    // Estado
    let map, origemMarker, destinoMarker, routeId = "rota-principal";
    let origemCoords = null, destinoCoords = null, rotaResumo = null;
    let origemContexto = null, destinoContexto = null;

    // Mapa
    initMap();
    function initMap(){
      console.log('Inicializando mapa...');
      console.log('Token:', MAPBOX_TOKEN ? 'Definido' : 'N√£o definido');
      console.log('Elemento map:', document.getElementById('map'));
      
      map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v12",
        center: [-51.9333, -23.4205], // Maring√°
        zoom: 12
      });
      
      map.on('load', function () {
        console.log('Mapa carregado com sucesso!');
      });
      
      map.on('error', function (e) {
        console.error('Erro no mapa:', e);
      });
      
      // Controles responsivos - posi√ß√£o baseada no tamanho da tela
      const isMobile = window.innerWidth <= 768;
      const controlPosition = isMobile ? 'bottom-right' : 'top-right';
      
      map.addControl(new mapboxgl.NavigationControl({ 
        visualizePitch: true,
        showCompass: true,
        showZoom: true
      }), controlPosition);
      
      map.addControl(new mapboxgl.GeolocateControl({ 
        positionOptions: { enableHighAccuracy: true }, 
        trackUserLocation: false,
        showAccuracyCircle: false
      }), controlPosition);
    }

    // Utils
    const $ = s => document.querySelector(s);
    const badge = m => $("#statusBadge").textContent = m;
    const toast = (m, ok=true)=>{ const el=$("#toast"); el.textContent=m; el.style.display="block"; el.style.borderColor= ok?"#1f3b26":"#522222"; el.style.background= ok?"#0e1a11":"#1e0e0e"; setTimeout(()=>el.style.display="none",4200); };
    const kmFmt = v => (v/1000).toFixed(2) + " km";
    const minFmt = v => Math.round(v/60) + " min";
    const money = v => v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

    function removeDiacritics(str){ return (str||"").normalize("NFD").replace(/\p{Diacritic}/gu,""); }
    function contemCidadeAlvo(place){
      const s = removeDiacritics(String(place||"").toLowerCase());
      const alvo = removeDiacritics(CIDADE_ALVO.toLowerCase());
      return s.includes(alvo);
    }

    // Autocomplete melhorado com foco em Maring√°
    let searchTimeout = null;
    let lastSearchQuery = '';
    
    // Aliases e sin√¥nimos para busca mais intuitiva
    const aliasesMaringa = {
      // Shoppings - varia√ß√µes e apelidos
      'bosque': ['Shopping Bosque dos Ip√™s', 'Bosque dos Ip√™s'],
      'ip√™s': ['Shopping Bosque dos Ip√™s'],
      'ipes': ['Shopping Bosque dos Ip√™s'],
      'cidade': ['Shopping Cidade Maring√°'],
      'catuai': ['Shopping Catua√≠ Maring√°', 'Catua√≠'],
      'catua√≠': ['Shopping Catua√≠ Maring√°'],
      'avenida center': ['Shopping Avenida Center'],
      'center': ['Shopping Avenida Center'],
      
      // Universidades
      'uem': ['UEM - Universidade Estadual de Maring√°', 'UEM'],
      'universidade': ['UEM - Universidade Estadual de Maring√°', 'UniCesumar'],
      'estadual': ['UEM - Universidade Estadual de Maring√°'],
      'cesumar': ['UniCesumar', 'Cesumar'],
      'unicesumar': ['UniCesumar'],
      
      // Transporte
      'terminal': ['Terminal Rodovi√°rio de Maring√°', 'Terminal Rodovi√°rio'],
      'rodoviaria': ['Terminal Rodovi√°rio de Maring√°'],
      'rodovi√°ria': ['Terminal Rodovi√°rio de Maring√°'],
      'aeroporto': ['Aeroporto Regional de Maring√°'],
      
      // Sa√∫de
      'hu': ['Hospital Universit√°rio'],
      'hospital universitario': ['Hospital Universit√°rio'],
      'hospital universit√°rio': ['Hospital Universit√°rio'],
      'santa casa': ['Santa Casa de Maring√°'],
      'metropolitano': ['Hospital Metropolitano'],
      
      // Parques
      'inga': ['Parque do Ing√°'],
      'ing√°': ['Parque do Ing√°'],
      'parque inga': ['Parque do Ing√°'],
      'parque ing√°': ['Parque do Ing√°'],
      'bosque 2': ['Bosque 2'],
      'horto': ['Parque Florestal', 'Horto Florestal'],
      'florestal': ['Parque Florestal'],
      'lago': ['Lago do Jaboti'],
      'jaboti': ['Lago do Jaboti'],
      
      // Pra√ßas
      'catedral': ['Pra√ßa da Catedral', 'Catedral Bas√≠lica'],
      'praca catedral': ['Pra√ßa da Catedral'],
      'pra√ßa catedral': ['Pra√ßa da Catedral'],
      'napoleao': ['Pra√ßa Napole√£o Moreira da Silva'],
      'napole√£o': ['Pra√ßa Napole√£o Moreira da Silva'],
      'raposo': ['Pra√ßa Raposo Tavares'],
      'rocha pombo': ['Pra√ßa Rocha Pombo'],
      
      // Centro e zonas
      'centro': ['Centro de Maring√°', 'Centro'],
      'zona 01': ['Zona 1'], 'zona 02': ['Zona 2'], 'zona 03': ['Zona 3'],
      'zona 04': ['Zona 4'], 'zona 05': ['Zona 5'], 'zona 06': ['Zona 6'],
      'zona 07': ['Zona 7'], 'zona 7': ['Zona 7'],
      
      // Avenidas
      'brasil': ['Avenida Brasil', 'Av Brasil'],
      'av brasil': ['Avenida Brasil'],
      'colombo': ['Avenida Colombo', 'Av Colombo'],
      'av colombo': ['Avenida Colombo'],
      'herval': ['Avenida Herval', 'Av Herval'],
      'av herval': ['Avenida Herval'],
      
      // Cultura
      'teatro': ['Teatro Calil Haddad', 'Teatro Municipal'],
      'mercadao': ['Mercad√£o', 'Mercado Municipal'],
      'mercad√£o': ['Mercad√£o', 'Mercado Municipal'],
      'mercado': ['Mercado Municipal']
    };
    
    // Refer√™ncias locais conhecidas de Maring√° (expandida)
    const referenciasMaringa = [
      // Shoppings
      { nome: "Shopping Bosque dos Ip√™s", coords: [-51.9392, -23.4205], categoria: "shopping" },
      { nome: "Shopping Cidade Maring√°", coords: [-51.9333, -23.4250], categoria: "shopping" },
      { nome: "Shopping Catua√≠ Maring√°", coords: [-51.9280, -23.4180], categoria: "shopping" },
      { nome: "Shopping Avenida Center", coords: [-51.9350, -23.4220], categoria: "shopping" },
      { nome: "Bosque dos Ip√™s", coords: [-51.9392, -23.4205], categoria: "shopping" },
      { nome: "Cidade Maring√°", coords: [-51.9333, -23.4250], categoria: "shopping" },
      { nome: "Catua√≠", coords: [-51.9280, -23.4180], categoria: "shopping" },
      
      // Parques e Bosques
      { nome: "Parque do Ing√°", coords: [-51.9380, -23.4100], categoria: "parque" },
      { nome: "Bosque 2", coords: [-51.9420, -23.4150], categoria: "parque" },
      { nome: "Parque Florestal", coords: [-51.9400, -23.4120], categoria: "parque" },
      { nome: "Horto Florestal", coords: [-51.9400, -23.4120], categoria: "parque" },
      { nome: "Lago do Jaboti", coords: [-51.9380, -23.4100], categoria: "parque" },
      
      // Pra√ßas
      { nome: "Pra√ßa da Catedral", coords: [-51.9333, -23.4205], categoria: "pra√ßa" },
      { nome: "Pra√ßa Napole√£o Moreira da Silva", coords: [-51.9300, -23.4180], categoria: "pra√ßa" },
      { nome: "Pra√ßa Raposo Tavares", coords: [-51.9380, -23.4220], categoria: "pra√ßa" },
      { nome: "Pra√ßa Rocha Pombo", coords: [-51.9320, -23.4200], categoria: "pra√ßa" },
      { nome: "Pra√ßa 7 de Setembro", coords: [-51.9340, -23.4210], categoria: "pra√ßa" },
      
      // Universidades e Escolas
      { nome: "UEM - Universidade Estadual de Maring√°", coords: [-51.9333, -23.4050], categoria: "universidade" },
      { nome: "UEM", coords: [-51.9333, -23.4050], categoria: "universidade" },
      { nome: "Universidade Estadual", coords: [-51.9333, -23.4050], categoria: "universidade" },
      { nome: "UniCesumar", coords: [-51.9200, -23.4300], categoria: "universidade" },
      { nome: "Cesumar", coords: [-51.9200, -23.4300], categoria: "universidade" },
      
      // Transporte
      { nome: "Terminal Rodovi√°rio de Maring√°", coords: [-51.9390, -23.4280], categoria: "transporte" },
      { nome: "Terminal Rodovi√°rio", coords: [-51.9390, -23.4280], categoria: "transporte" },
      { nome: "Rodovi√°ria", coords: [-51.9390, -23.4280], categoria: "transporte" },
      { nome: "Aeroporto Regional de Maring√°", coords: [-51.8950, -23.4760], categoria: "transporte" },
      { nome: "Aeroporto", coords: [-51.8950, -23.4760], categoria: "transporte" },
      
      // Sa√∫de
      { nome: "Hospital Universit√°rio", coords: [-51.9320, -23.4080], categoria: "sa√∫de" },
      { nome: "HU", coords: [-51.9320, -23.4080], categoria: "sa√∫de" },
      { nome: "Santa Casa de Maring√°", coords: [-51.9340, -23.4190], categoria: "sa√∫de" },
      { nome: "Santa Casa", coords: [-51.9340, -23.4190], categoria: "sa√∫de" },
      { nome: "Hospital Metropolitano", coords: [-51.9250, -23.4150], categoria: "sa√∫de" },
      
      // Centro e Bairros
      { nome: "Centro de Maring√°", coords: [-51.9333, -23.4205], categoria: "centro" },
      { nome: "Centro", coords: [-51.9333, -23.4205], categoria: "centro" },
      { nome: "Zona 7", coords: [-51.9280, -23.4150], categoria: "bairro" },
      { nome: "Jardim Alvorada", coords: [-51.9180, -23.4300], categoria: "bairro" },
      { nome: "Vila Esperan√ßa", coords: [-51.9450, -23.4100], categoria: "bairro" },
      { nome: "Novo Centro", coords: [-51.9200, -23.4180], categoria: "bairro" },
      { nome: "Zona 1", coords: [-51.9350, -23.4180], categoria: "bairro" },
      { nome: "Zona 2", coords: [-51.9320, -23.4200], categoria: "bairro" },
      { nome: "Zona 3", coords: [-51.9300, -23.4220], categoria: "bairro" },
      { nome: "Zona 4", coords: [-51.9280, -23.4180], categoria: "bairro" },
      { nome: "Zona 5", coords: [-51.9320, -23.4160], categoria: "bairro" },
      { nome: "Zona 6", coords: [-51.9300, -23.4140], categoria: "bairro" },
      
      // Avenidas Principais
      { nome: "Avenida Brasil", coords: [-51.9333, -23.4205], categoria: "avenida" },
      { nome: "Av Brasil", coords: [-51.9333, -23.4205], categoria: "avenida" },
      { nome: "Avenida Colombo", coords: [-51.9300, -23.4100], categoria: "avenida" },
      { nome: "Av Colombo", coords: [-51.9300, -23.4100], categoria: "avenida" },
      { nome: "Avenida Herval", coords: [-51.9350, -23.4200], categoria: "avenida" },
      { nome: "Av Herval", coords: [-51.9350, -23.4200], categoria: "avenida" },
      
      // Pontos de Refer√™ncia
      { nome: "Catedral Bas√≠lica", coords: [-51.9333, -23.4205], categoria: "religioso" },
      { nome: "Catedral", coords: [-51.9333, -23.4205], categoria: "religioso" },
      { nome: "Teatro Calil Haddad", coords: [-51.9340, -23.4200], categoria: "cultura" },
      { nome: "Teatro Municipal", coords: [-51.9340, -23.4200], categoria: "cultura" },
      { nome: "Mercad√£o", coords: [-51.9320, -23.4215], categoria: "comercio" },
      { nome: "Mercado Municipal", coords: [-51.9320, -23.4215], categoria: "comercio" }
    ];
    
    async function sugestoesEndereco(q, datalistId){
      const input = datalistId === 'lista-origem' ? $("#origem") : $("#destino");
      
      if(!q || q.length < 2) {
        document.getElementById(datalistId).innerHTML = "";
        input.classList.remove('searching');
        return;
      }
      
      // Visual feedback de busca
      input.classList.add('searching');
      
      // Debounce para evitar muitas requisi√ß√µes
      if(searchTimeout) clearTimeout(searchTimeout);
      
      searchTimeout = setTimeout(async () => {
        try{
          const list = document.getElementById(datalistId); 
          list.innerHTML = "";
          
          // 1. PRIMEIRO: Buscar nas refer√™ncias locais
          const refsEncontradas = buscarReferenciasLocais(q);
          
          // 2. SEGUNDO: Buscar na API do Mapbox com foco em Maring√°
          const resultadosMapbox = await buscarEnderecoMapbox(q);
          
          // 3. Combinar e ordenar resultados
          const todosResultados = [...refsEncontradas, ...resultadosMapbox];
          
          if(todosResultados.length > 0) {
            // Ordena: Maring√° primeiro, depois por relev√¢ncia
            todosResultados.sort((a, b) => {
              // Prioridade 1: Refer√™ncias locais primeiro
              if(a.isLocal && !b.isLocal) return -1;
              if(!a.isLocal && b.isLocal) return 1;
              
              // Prioridade 2: Endere√ßos de Maring√°
              const aTemMaringa = a.place_name?.toLowerCase().includes('maring√°') || a.nome?.toLowerCase().includes('maring√°');
              const bTemMaringa = b.place_name?.toLowerCase().includes('maring√°') || b.nome?.toLowerCase().includes('maring√°');
              
              if(aTemMaringa && !bTemMaringa) return -1;
              if(!aTemMaringa && bTemMaringa) return 1;
              
              // Prioridade 3: Dist√¢ncia de Maring√° (para resultados da API)
              if(a.distance !== undefined && b.distance !== undefined) {
                return a.distance - b.distance;
              }
              
              return 0;
            });
            
            // Limita a 8 resultados
            const resultadosLimitados = todosResultados.slice(0, 8);
            
            resultadosLimitados.forEach(resultado => {
              const opt = document.createElement("option");
              
              if(resultado.isLocal) {
                // Refer√™ncia local
                const icone = getIconeCategoria(resultado.categoria);
                const badge = resultado.isExactMatch ? 'üéØ' : '';
                opt.value = resultado.nome;
                opt.textContent = `${icone} ${resultado.nome} ${badge}`;
                opt.setAttribute('data-coordinates', JSON.stringify(resultado.coords));
                opt.setAttribute('data-context', JSON.stringify({
                  place_name: resultado.nome,
                  center: resultado.coords,
                  place_type: ['poi'],
                  properties: { category: resultado.categoria }
                }));
              } else {
                // Resultado da API Mapbox
                let displayName = resultado.place_name;
                const temMaringa = displayName.toLowerCase().includes('maring√°');
                
                // √çcone baseado no tipo
                let icone = 'üìç';
                if(resultado.place_type?.includes('address')) icone = 'üè†';
                else if(resultado.place_type?.includes('poi')) icone = 'üìç';
                else if(resultado.place_type?.includes('place')) icone = 'üèôÔ∏è';
                
                // Destaca se √© de Maring√°
                if(temMaringa) {
                  opt.value = resultado.place_name;
                  opt.textContent = `${icone} ${displayName} ‚≠ê`;
                } else {
                  opt.value = resultado.place_name;
                  opt.textContent = `${icone} ${displayName}`;
                }
                
                opt.setAttribute('data-coordinates', JSON.stringify(resultado.center));
                opt.setAttribute('data-context', JSON.stringify(resultado));
              }
              
              list.appendChild(opt);
            });
            
            // Feedback visual de sucesso
            input.style.borderColor = '#34c759';
            setTimeout(() => {
              input.style.borderColor = '';
              input.classList.remove('searching');
            }, 800);
            
          } else {
            // Sem resultados
            const opt = document.createElement("option");
            opt.value = q;
            opt.textContent = `‚ùå Nenhum resultado encontrado para "${q}"`;
            opt.disabled = true;
            list.appendChild(opt);
            
            // Feedback visual de erro
            input.style.borderColor = '#ff5252';
            setTimeout(() => {
              input.style.borderColor = '';
              input.classList.remove('searching');
            }, 1200);
          }
        } catch(error) {
          console.error('Erro na busca de endere√ßos:', error);
          const list = document.getElementById(datalistId);
          list.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = q;
          opt.textContent = `‚ö†Ô∏è Erro na busca. Tente novamente.`;
          opt.disabled = true;
          list.appendChild(opt);
          
          // Feedback visual de erro
          input.style.borderColor = '#ff5252';
          setTimeout(() => {
            input.style.borderColor = '';
            input.classList.remove('searching');
          }, 1500);
        }
      }, 300); // Aguarda 300ms antes de fazer a busca
    }
    
    async function buscarResultadosInteligentes(query) {
      const q = query.toLowerCase().trim();
      let resultados = [];
      
      // 1. Busca por aliases e sin√¥nimos
      const resultadosAlias = buscarPorAlias(q);
      resultados = resultados.concat(resultadosAlias);
      
      // 2. Busca fuzzy nas refer√™ncias locais
      const resultadosFuzzy = buscarReferenciasLocais(q);
      resultados = resultados.concat(resultadosFuzzy);
      
      // 3. Busca na API Mapbox
      if(q.length >= 2) {
        const resultadosMapbox = await buscarEnderecoMapbox(q);
        resultados = resultados.concat(resultadosMapbox);
      }
      
      // 4. Ordena por relev√¢ncia
      return ordenarPorRelevancia(resultados, q);
    }
    
    function buscarPorAlias(query) {
      const resultados = [];
      
      for(const [alias, referencias] of Object.entries(aliasesMaringa)) {
        if(alias === query || alias.includes(query) || query.includes(alias)) {
          referencias.forEach(refNome => {
            const refCompleta = referenciasMaringa.find(r => r.nome === refNome);
            if(refCompleta) {
              resultados.push({
                ...refCompleta,
                isLocal: true,
                isExactMatch: alias === query,
                relevancia: alias === query ? 100 : 80
              });
            }
          });
        }
      }
      
      return resultados;
    }
    
    function buscarReferenciasLocais(query) {
      return referenciasMaringa
        .map(ref => {
          const score = calcularSimilaridade(query, ref.nome.toLowerCase());
          return score > 0.3 ? {
            ...ref,
            isLocal: true,
            relevancia: score * 70,
            isPartialMatch: score > 0.6
          } : null;
        })
        .filter(Boolean);
    }
    
    function calcularSimilaridade(query, texto) {
      // Busca exata
      if(texto.includes(query)) return 1.0;
      
      // Busca por palavras
      const palavrasQuery = query.split(' ');
      const palavrasTexto = texto.split(' ');
      let matches = 0;
      
      palavrasQuery.forEach(pq => {
        if(palavrasTexto.some(pt => pt.includes(pq) || pq.includes(pt))) {
          matches++;
        }
      });
      
      return matches / palavrasQuery.length;
    }
    
    function ordenarPorRelevancia(resultados, query) {
      return resultados.sort((a, b) => {
        // Prioridade 1: Matches exatos
        if(a.isExactMatch && !b.isExactMatch) return -1;
        if(!a.isExactMatch && b.isExactMatch) return 1;
        
        // Prioridade 2: Refer√™ncias locais
        if(a.isLocal && !b.isLocal) return -1;
        if(!a.isLocal && b.isLocal) return 1;
        
        // Prioridade 3: Relev√¢ncia/score
        if(a.relevancia && b.relevancia) {
          return b.relevancia - a.relevancia;
        }
        
        // Prioridade 4: Endere√ßos de Maring√°
        const aMaringa = (a.place_name || a.nome || '').toLowerCase().includes('maring√°');
        const bMaringa = (b.place_name || b.nome || '').toLowerCase().includes('maring√°');
        
        if(aMaringa && !bMaringa) return -1;
        if(!aMaringa && bMaringa) return 1;
        
        // Prioridade 5: Dist√¢ncia
        return (a.distance || 0) - (b.distance || 0);
      });
    }
    
    function removeDuplicatas(resultados) {
      const vistos = new Set();
      return resultados.filter(resultado => {
        const key = (resultado.nome || resultado.place_name || '').toLowerCase();
        if(vistos.has(key)) return false;
        vistos.add(key);
        return true;
      });
    }
    
    function getIconeByPlaceType(placeTypes) {
      if(!placeTypes) return 'üìç';
      
      if(placeTypes.includes('address')) return 'üè†';
      if(placeTypes.includes('poi')) return 'üìç';
      if(placeTypes.includes('place')) return 'üèôÔ∏è';
      if(placeTypes.includes('locality')) return 'üèòÔ∏è';
      if(placeTypes.includes('neighborhood')) return 'üèòÔ∏è';
      
      return 'üìç';
    }
    
    function adicionarSugestoesAlternativas(list, query) {
      const opt = document.createElement("option");
      opt.value = '';
      opt.textContent = `‚ùå Nenhum resultado para "${query}"`;
      opt.disabled = true;
      list.appendChild(opt);
      
      // Adiciona sugest√µes populares
      adicionarSugestoesPopulares(list, true);
    }
    
    function adicionarSugestoesPopulares(list, isAlternative = false) {
      const populares = [
        'Shopping Bosque dos Ip√™s',
        'Centro de Maring√°', 
        'UEM',
        'Terminal Rodovi√°rio',
        'Shopping Catua√≠ Maring√°'
      ];
    // Fun√ß√£o para buscar nas refer√™ncias locais
    function buscarReferenciasLocais(query) {
      const q = query.toLowerCase().trim();
      
      return referenciasMaringa
        .filter(ref => {
          const nomeMatch = ref.nome.toLowerCase().includes(q);
          const categoriaMatch = ref.categoria.toLowerCase().includes(q);
          return nomeMatch || categoriaMatch;
        })
        .map(ref => ({
          ...ref,
          isLocal: true,
          isExactMatch: ref.nome.toLowerCase() === q
        }));
    }

    // Fun√ß√£o para buscar no Mapbox com foco em Maring√°
    async function buscarEnderecoMapbox(query) {
      const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&proximity=-51.9386,-23.4205&bbox=-52.1,-23.6,-51.7,-23.2&country=BR&language=pt&limit=6`;
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        
        return data.features.map(feature => ({
          ...feature,
          isLocal: false,
          distance: calcularDistanciaParaMaringa(feature.center)
        }));
      } catch (error) {
        console.error('Erro na busca Mapbox:', error);
        return [];
      }
    }

    // Fun√ß√£o para calcular dist√¢ncia at√© Maring√°
    function calcularDistanciaParaMaringa(coords) {
      const MARINGA_CENTER = [-51.9386, -23.4205];
      const [lng, lat] = coords;
      
      const R = 6371; // Raio da Terra em km
      const dLat = (lat - MARINGA_CENTER[1]) * Math.PI / 180;
      const dLng = (lng - MARINGA_CENTER[0]) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(MARINGA_CENTER[1] * Math.PI / 180) * Math.cos(lat * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      
      return R * c;
    }

    // Fun√ß√£o para obter √≠cone baseado na categoria
    function getIconeCategoria(categoria) {
      const icones = {
        'shopping': 'üõçÔ∏è',
        'hospital': 'üè•',
        'escola': 'üè´',
        'universidade': 'üéì',
        'parque': 'üå≥',
        'religioso': '‚õ™',
        'restaurante': 'üçΩÔ∏è',
        'hotel': 'üè®',
        'transporte': 'üöå',
        'governo': 'üèõÔ∏è',
        'aeroporto': '‚úàÔ∏è',
        'posto': '‚õΩ',
        'banco': 'üè¶',
        'supermercado': 'üõí'
      };
      
      return icones[categoria] || 'üìç';
    }
      const sinonimos = {
        'bosque': 'Shopping Bosque dos Ip√™s',
        'ipes': 'Shopping Bosque dos Ip√™s',
        'ip√™s': 'Shopping Bosque dos Ip√™s',
        'ip√©': 'Shopping Bosque dos Ip√™s',
        'cidade': 'Shopping Cidade Maring√°',
        'catuai': 'Shopping Catua√≠ Maring√°',
        'catua√≠': 'Shopping Catua√≠ Maring√°',
        'catu√°': 'Shopping Catua√≠ Maring√°',
        'uem': 'UEM - Universidade Estadual de Maring√°',
        'universidade': 'UEM - Universidade Estadual de Maring√°',
        'estadual': 'UEM - Universidade Estadual de Maring√°',
        'terminal': 'Terminal Rodovi√°rio de Maring√°',
        'rodoviaria': 'Terminal Rodovi√°rio de Maring√°',
        'rodovi√°ria': 'Terminal Rodovi√°rio de Maring√°',
        'aeroporto': 'Aeroporto Regional de Maring√°',
        'airport': 'Aeroporto Regional de Maring√°',
        'hu': 'Hospital Universit√°rio',
        'hospital': 'Hospital Universit√°rio',
        'santa casa': 'Santa Casa de Maring√°',
        'santa': 'Santa Casa de Maring√°',
        'inga': 'Parque do Ing√°',
        'ing√°': 'Parque do Ing√°',
        'parque': 'Parque do Ing√°',
        'catedral': 'Pra√ßa da Catedral',
        'igreja': 'Catedral Bas√≠lica',
        'centro': 'Centro de Maring√°',
        'downtown': 'Centro de Maring√°',
        'teatro': 'Teatro Calil Haddad',
        'mercadao': 'Mercad√£o',
        'mercad√£o': 'Mercad√£o',
        'mercado': 'Mercado Municipal',
        'shopping': 'Shopping Bosque dos Ip√™s',
        'mall': 'Shopping Bosque dos Ip√™s'
      };
      
      let resultados = [];
      
      // Busca por sin√¥nimos primeiro
      if(sinonimos[q]) {
        const ref = referenciasMaringa.find(r => r.nome === sinonimos[q]);
        if(ref) {
          resultados.push({...ref, isLocal: true, distance: 0, isExactMatch: true});
        }
      }
      
      // Busca normal nas refer√™ncias (evita duplicatas)
      const encontradas = referenciasMaringa
        .filter(ref => {
          const jaEncontrada = resultados.some(r => r.nome === ref.nome);
          return !jaEncontrada && (
            ref.nome.toLowerCase().includes(q) || 
            ref.categoria.toLowerCase().includes(q)
          );
        })
        .map(ref => ({
          ...ref,
          isLocal: true,
          distance: 0
        }));
      
      return [...resultados, ...encontradas];
    }
    
    async function buscarEnderecoMapbox(query) {
      const params = new URLSearchParams({
        autocomplete: 'true',
        limit: '6', // Reduzido para dar espa√ßo √†s refer√™ncias locais
        language: 'pt-BR',
        country: 'BR',
        types: 'address,poi,place,locality,neighborhood',
        proximity: '-51.9333,-23.4205', // Centro de Maring√°
        bbox: '-52.2,-23.8,-51.6,-23.1', // Bounding box de Maring√° e regi√£o
        access_token: MAPBOX_TOKEN
      });
      
      const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?${params}`;
      const r = await fetch(url);
      
      if(!r.ok) throw new Error('Erro na API');
      
      const j = await r.json();
      
      if(j.features && j.features.length > 0) {
        // Calcula dist√¢ncia de Maring√° para cada resultado
        return j.features.map(feature => {
          const [lon, lat] = feature.center;
          const distance = calcularDistanciaMaringa(lat, lon);
          return {
            ...feature,
            distance,
            isLocal: false
          };
        });
      }
      
      return [];
    }
    
    function calcularDistanciaMaringa(lat, lon) {
      const maringaLat = -23.4205;
      const maringaLon = -51.9333;
      
      const R = 6371; // Raio da Terra em km
      const dLat = (lat - maringaLat) * Math.PI / 180;
      const dLon = (lon - maringaLon) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(maringaLat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    function getIconeCategoria(categoria) {
      const icones = {
        shopping: 'üõçÔ∏è',
        parque: 'üå≥',
        pra√ßa: 'üèõÔ∏è',
        universidade: 'üéì',
        transporte: 'üöå',
        sa√∫de: 'üè•',
        centro: 'üè¢',
        bairro: 'üèòÔ∏è',
        avenida: 'üõ£Ô∏è',
        religioso: '‚õ™',
        cultura: 'üé≠',
        comercio: 'üè™'
      };
      return icones[categoria] || 'üìç';
    }
    
    // Event listeners melhorados para autocomplete
    $("#origem").addEventListener("input", e => {
      sugestoesEndereco(e.target.value, "lista-origem");
    });
    
    $("#destino").addEventListener("input", e => {
      sugestoesEndereco(e.target.value, "lista-destino");
    });
    
    // Melhorias na experi√™ncia de busca
    $("#origem").addEventListener("focus", () => {
      if(!$("#origem").value) {
        // Mostra sugest√µes populares quando foca no campo vazio
        const list = document.getElementById("lista-origem");
        list.innerHTML = "";
        
        const populares = ['Centro', 'UEM', 'Bosque', 'Terminal', 'Catua√≠'];
        populares.forEach(nome => {
          const opt = document.createElement("option");
          opt.value = nome;
          opt.textContent = `üí° ${nome}`;
          list.appendChild(opt);
        });
      }
    });
    
    $("#destino").addEventListener("focus", () => {
      if(!$("#destino").value) {
        // Mostra sugest√µes populares quando foca no campo vazio
        const list = document.getElementById("lista-destino");
        list.innerHTML = "";
        
        const populares = ['Aeroporto', 'HU', 'Santa Casa', 'Teatro', 'Mercad√£o'];
        populares.forEach(nome => {
          const opt = document.createElement("option");
          opt.value = nome;
          opt.textContent = `üí° ${nome}`;
          list.appendChild(opt);
        });
      }
    });
    
    // Captura quando usu√°rio seleciona uma op√ß√£o do datalist
    $("#origem").addEventListener("change", function(e) {
      const selectedOption = document.querySelector(`#lista-origem option[value="${e.target.value}"]`);
      if(selectedOption) {
        const coords = selectedOption.getAttribute('data-coordinates');
        const context = selectedOption.getAttribute('data-context');
        if(coords) {
          origemCoords = JSON.parse(coords);
          origemContexto = context ? JSON.parse(context) : null;
          posicionarMarcador("origem", origemCoords, e.target.value);
          badge("Origem selecionada da lista.");
          ajustarVisao();
        }
      } else {
        // Se digitou algo que n√£o est√° na lista, limpa coordenadas
        origemCoords = null; 
        origemContexto = null;
      }
    });
    
    $("#destino").addEventListener("change", function(e) {
      const selectedOption = document.querySelector(`#lista-destino option[value="${e.target.value}"]`);
      if(selectedOption) {
        const coords = selectedOption.getAttribute('data-coordinates');
        const context = selectedOption.getAttribute('data-context');
        if(coords) {
          destinoCoords = JSON.parse(coords);
          destinoContexto = context ? JSON.parse(context) : null;
          posicionarMarcador("destino", destinoCoords, e.target.value);
          badge("Destino selecionado da lista.");
          ajustarVisao();
        }
      } else {
        // Se digitou algo que n√£o est√° na lista, limpa coordenadas
        destinoCoords = null; 
        destinoContexto = null;
      }
    });

    // Geo melhorado
    $("#btnGeo").addEventListener("click", ()=>{
      if(!navigator.geolocation){ 
        toast("Geolocaliza√ß√£o n√£o est√° dispon√≠vel neste dispositivo", false); 
        return; 
      }
      
      badge("Obtendo sua localiza√ß√£o...");
      $("#btnGeo").disabled = true;
      $("#btnGeo").textContent = "Localizando...";
      
      navigator.geolocation.getCurrentPosition(async pos=>{
        const { latitude:lat, longitude:lon } = pos.coords;
        origemCoords = [lon, lat];
        
        try{
          // Busca reversa mais detalhada
          const params = new URLSearchParams({
            language: 'pt-BR',
            types: 'address,poi,place',
            limit: '1',
            access_token: MAPBOX_TOKEN
          });
          
          const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lon},${lat}.json?${params}`;
          const r = await fetch(url); 
          
          if(!r.ok) throw new Error('Erro na geocodifica√ß√£o reversa');
          
          const j = await r.json();
          const feat = j.features?.[0]; 
          
          if(feat) {
            const place = feat.place_name;
            origemContexto = feat;
            $("#origem").value = place;
            posicionarMarcador("origem", origemCoords, place);
            badge("Localiza√ß√£o atual definida como origem.");
            toast("‚úÖ Localiza√ß√£o obtida com sucesso!");
          } else {
            // Fallback para coordenadas
            const coordsText = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
            $("#origem").value = coordsText;
            posicionarMarcador("origem", origemCoords, "Minha localiza√ß√£o");
            badge("Coordenadas definidas como origem.");
            toast("üìç Localiza√ß√£o obtida (coordenadas)");
          }
          
          ajustarVisao();
        } catch(error) {
          console.error('Erro na geocodifica√ß√£o reversa:', error);
          const coordsText = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
          $("#origem").value = coordsText;
          posicionarMarcador("origem", origemCoords, "Minha localiza√ß√£o");
          badge("Coordenadas obtidas.");
          toast("üìç Localiza√ß√£o obtida (sem endere√ßo)");
        }
      }, (error) => {
        console.error('Erro de geolocaliza√ß√£o:', error);
        let errorMsg = "N√£o foi poss√≠vel obter sua localiza√ß√£o";
        
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMsg = "Permiss√£o de localiza√ß√£o negada";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMsg = "Localiza√ß√£o indispon√≠vel";
            break;
          case error.TIMEOUT:
            errorMsg = "Tempo limite para obter localiza√ß√£o";
            break;
        }
        
        toast(errorMsg, false);
        badge("Erro ao obter localiza√ß√£o.");
      }, {
        enableHighAccuracy: true,
        timeout: 15000, // 15 segundos
        maximumAge: 300000 // Cache por 5 minutos
      });
      
      // Restaura bot√£o ap√≥s 2 segundos independente do resultado
      setTimeout(() => {
        $("#btnGeo").disabled = false;
        $("#btnGeo").textContent = "Usar minha localiza√ß√£o";
      }, 2000);
    });

    // Rota
    $("#btnRota").addEventListener("click", async ()=>{ await calcularERedesenharRota(); });

    async function calcularERedesenharRota(){
      badge("Calculando rota...");
      const origem = $("#origem").value.trim();
      const destino = $("#destino").value.trim();
      
      if(!origem || !destino){ 
        toast("Por favor, informe origem e destino", false); 
        badge("Informe origem e destino."); 
        return; 
      }

      // Se j√° tem coordenadas dos autocompletes, usa elas
      let geoO = null, geoD = null;
      
      if(!origemCoords) {
        badge("Geocodificando origem...");
        geoO = await geocodeCompleto(origem);
        if(!geoO) {
          toast("‚ùå Endere√ßo de origem n√£o encontrado", false);
          badge("Origem n√£o encontrada.");
          return;
        }
        origemCoords = geoO.center;
        origemContexto = geoO;
      }
      
      if(!destinoCoords) {
        badge("Geocodificando destino...");
        geoD = await geocodeCompleto(destino);
        if(!geoD) {
          toast("‚ùå Endere√ßo de destino n√£o encontrado", false);
          badge("Destino n√£o encontrado.");
          return;
        }
        destinoCoords = geoD.center;
        destinoContexto = geoD;
      }

      if(!origemCoords || !destinoCoords){ 
        toast("Endere√ßos inv√°lidos ou n√£o encontrados", false); 
        badge("Falha ao encontrar endere√ßos."); 
        return; 
      }

      badge("Tra√ßando rota...");
      await desenharRota(origemCoords, destinoCoords);
      atualizarKPIs();
    }

    async function geocodeCompleto(texto){
      try{
        // Primeiro, verifica se √© uma refer√™ncia local conhecida
        const refLocal = referenciasMaringa.find(ref => 
          ref.nome.toLowerCase() === texto.toLowerCase().trim()
        );
        
        if(refLocal) {
          return {
            place_name: refLocal.nome,
            center: refLocal.coords,
            place_type: ['poi'],
            properties: { category: refLocal.categoria }
          };
        }
        
        // Se n√£o √© refer√™ncia local, busca na API com foco em Maring√°
        const params = new URLSearchParams({
          limit: '5',
          language: 'pt-BR',
          country: 'BR',
          types: 'address,poi,place,locality,neighborhood',
          proximity: '-51.9333,-23.4205', // Proximidade com Maring√°
          bbox: '-52.2,-23.8,-51.6,-23.1', // Bounding box de Maring√° e regi√£o
          access_token: MAPBOX_TOKEN
        });
        
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(texto)}.json?${params}`;
        const r = await fetch(url); 
        
        if(!r.ok) throw new Error('Erro na API de geocodifica√ß√£o');
        
        const j = await r.json();
        
        if(j.features && j.features.length > 0) {
          // Prioriza resultados de Maring√°
          let bestMatch = j.features[0];
          
          // Busca especificamente por resultados em Maring√° primeiro
          for(let feature of j.features) {
            const place_name = feature.place_name.toLowerCase();
            
            // Se cont√©m "maring√°", tem prioridade m√°xima
            if(place_name.includes('maring√°')) {
              bestMatch = feature;
              
              // Se √© endere√ßo espec√≠fico em Maring√°, retorna imediatamente
              if(feature.place_type.includes('address')) {
                break;
              }
            }
            // Se n√£o tem nenhum resultado de Maring√° ainda, prioriza por tipo
            else if(!bestMatch.place_name.toLowerCase().includes('maring√°')) {
              if(feature.place_type.includes('address')) {
                bestMatch = feature;
              } else if(feature.place_type.includes('poi') && !bestMatch.place_type.includes('address')) {
                bestMatch = feature;
              }
            }
          }
          
          return bestMatch;
        }
        
        return null;
      } catch(error) {
        console.error('Erro no geocodeCompleto:', error);
        return null;
      }
    }

    async function desenharRota([lonA,latA],[lonB,latB]){
      try{
        const url=`https://api.mapbox.com/directions/v5/mapbox/driving/${lonA},${latA};${lonB},${latB}?geometries=geojson&overview=full&language=pt-BR&access_token=${MAPBOX_TOKEN}`;
        const r=await fetch(url); const j=await r.json();
        const route=j.routes?.[0]; if(!route) throw new Error("Sem rota");
        const line=route.geometry;
        rotaResumo={ distancia:route.distance, duracao:route.duration };

        if(map.getSource(routeId)){
          map.getSource(routeId).setData({type:"Feature",geometry:line});
        }else{
          map.addSource(routeId,{type:"geojson",data:{type:"Feature",geometry:line}});
          map.addLayer({ id:routeId, type:"line", source:routeId, layout:{ "line-join":"round","line-cap":"round" }, paint:{ "line-color":"#34c759","line-width":5,"line-opacity":.9 }});
        }

        posicionarMarcador("origem",[lonA,latA],$("#origem").value);
        posicionarMarcador("destino",[lonB,latB],$("#destino").value);
        ajustarVisao();
        badge("Rota pronta.");
      }catch(e){
        toast("N√£o foi poss√≠vel tra√ßar a rota", false);
        badge("Erro ao obter rota.");
      }
    }

    function posicionarMarcador(tipo,[lon,lat],titulo){
      const color = tipo==="origem" ? "#2bb44f" : "#1ea7fd";
      const el=document.createElement("div");
      el.style.width="16px"; el.style.height="16px"; el.style.borderRadius="50%";
      el.style.background=color; el.style.boxShadow="0 0 0 3px rgba(255,255,255,.3)";
      const marker=new mapboxgl.Marker({element:el}).setLngLat([lon,lat]).setPopup(new mapboxgl.Popup({offset:24}).setText(titulo));
      if(tipo==="origem"){ if(origemMarker) origemMarker.remove(); origemMarker=marker; } else { if(destinoMarker) destinoMarker.remove(); destinoMarker=marker; }
      marker.addTo(map);
    }
    function ajustarVisao(){
      const b=new mapboxgl.LngLatBounds();
      if(origemMarker) b.extend(origemMarker.getLngLat());
      if(destinoMarker) b.extend(destinoMarker.getLngLat());
      if(!b.isEmpty()) map.fitBounds(b,{padding:60,duration:600,maxZoom:14});
    }

    // Tarifa√ß√£o
    function tipoCorrida(){
      const oEmMGA = contemCidadeAlvo(origemContexto?.place_name);
      const dEmMGA = contemCidadeAlvo(destinoContexto?.place_name);
      return (oEmMGA && dEmMGA) ? "dentro" : "fora";
    }
    function calcularPreco(){
      if(!rotaResumo) return null;
      const km = rotaResumo.distancia/1000;
      const min = Math.round(rotaResumo.duracao/60);
      if(tipoCorrida()==="dentro"){
        return { tipo:"Dentro de Maring√°", valor: km*PRECO_INTERNO_POR_KM + min*PRECO_INTERNO_POR_MIN, km, min };
      }else{
        return { tipo:"Fora de Maring√°", valor: km*PRECO_FORA_POR_KM, km, min };
      }
    }
    function atualizarKPIs(){
      if(!rotaResumo) return;
      const fare = calcularPreco();
      $("#kpis").hidden=false;
      $("#kpiDist").textContent = kmFmt(rotaResumo.distancia);
      $("#kpiTempo").textContent = minFmt(rotaResumo.duracao);
      $("#kpiTipo").textContent  = fare?.tipo || "‚Äî";
      $("#kpiPreco").textContent = fare ? money(fare.valor) : "‚Äî";
    }

    // Envio ao webhook
    $("#rideForm").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const nome=$("#nome").value.trim();
      const telefone=$("#telefone").value.trim();
      const origemTxt=$("#origem").value.trim();
      const destinoTxt=$("#destino").value.trim();
      const quando=$("#quando").value;
      const observacoes=$("#observacoes").value.trim();
      if(!origemTxt||!destinoTxt||!quando||!nome){ toast("Preencha os campos obrigat√≥rios", false); return; }

      if(!rotaResumo){ await calcularERedesenharRota(); if(!rotaResumo){ toast("Calcule a rota antes de enviar", false); return; } }

      badge("Enviando ao webhook...");
      const [oLon,oLat]=origemCoords||[null,null];
      const [dLon,dLat]=destinoCoords||[null,null];

      const rotaLink = (oLat&&oLon&&dLat&&dLon)
        ? `https://www.google.com/maps/dir/?api=1&origin=${oLat},${oLon}&destination=${dLat},${dLon}&travelmode=driving`
        : null;

      const quandoISO = quando ? new Date(quando) : null;
      const quandoBR = quandoISO ? new Intl.DateTimeFormat('pt-BR',{dateStyle:'short',timeStyle:'short',timeZone:'America/Sao_Paulo'}).format(quandoISO) : "";

      const fare = calcularPreco();

      const payload = {
        nome, telefone,
        origem: { endereco: origemTxt, lon:oLon, lat:oLat, em_maringa: contemCidadeAlvo(origemContexto?.place_name) },
        destino: { endereco: destinoTxt, lon:dLon, lat:dLat, em_maringa: contemCidadeAlvo(destinoContexto?.place_name) },
        quando: { raw: quando, ptBR: quandoBR },
        observacoes,
        rota: {
          distancia_m: rotaResumo?.distancia ?? null,
          duracao_s:   rotaResumo?.duracao ?? null,
          distancia_km_fmt: rotaResumo ? (rotaResumo.distancia/1000).toFixed(2) : null,
          duracao_min_fmt:  rotaResumo ? Math.round(rotaResumo.duracao/60) : null,
          link_motorista: rotaLink
        },
        preco: fare ? {
          tipo: fare.tipo,
          valor_brl: Number(fare.valor.toFixed(2)),
          regras: {
            dentro:{ km: PRECO_INTERNO_POR_KM, min: PRECO_INTERNO_POR_MIN },
            fora:{ km: PRECO_FORA_POR_KM }
          }
        } : null,
        meta:{ cidade:"Maring√°-PR", origem_app:"app-html-mobilidade", enviado_em_iso:new Date().toISOString() }
      };

      try{
        const resp = await fetch(N8N_WEBHOOK_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
        if(!resp.ok) throw new Error("HTTP "+resp.status);
        toast("Pedido enviado ao webhook.");
        badge("Enviado com sucesso.");
      }catch(e){
        toast("Falha no webhook. Revise a URL.", false);
        badge("Erro no envio.");
      }
    });

    // Limpar
    $("#btnLimpar").addEventListener("click",()=>{
      $("#rideForm").reset();
      $("#kpis").hidden=true; rotaResumo=null; origemCoords=null; destinoCoords=null;
      origemContexto=null; destinoContexto=null;
      if(map.getSource(routeId)){ map.removeLayer(routeId); map.removeSource(routeId); }
      if(origemMarker){ origemMarker.remove(); origemMarker=null; }
      if(destinoMarker){ destinoMarker.remove(); destinoMarker=null; }
      badge("Pronto para tra√ßar rota.");
    });

    // Reajuste dos controles do mapa quando a tela √© redimensionada
    window.addEventListener('resize', () => {
      if (map) {
        map.resize();
        
        // Reposicionar controles baseado no novo tamanho
        const isMobile = window.innerWidth <= 768;
        const controls = document.querySelectorAll('.mapboxgl-ctrl-top-right, .mapboxgl-ctrl-bottom-right');
        
        // Se mudou de desktop para mobile ou vice-versa, recriar controles
        if ((isMobile && document.querySelector('.mapboxgl-ctrl-top-right')) ||
            (!isMobile && document.querySelector('.mapboxgl-ctrl-bottom-right'))) {
          // Remove controles existentes
          document.querySelectorAll('.mapboxgl-ctrl').forEach(ctrl => ctrl.remove());
          
          // Recriar controles na posi√ß√£o correta
          const controlPosition = isMobile ? 'bottom-right' : 'top-right';
          
          map.addControl(new mapboxgl.NavigationControl({ 
            visualizePitch: true,
            showCompass: true,
            showZoom: true
          }), controlPosition);
          
          map.addControl(new mapboxgl.GeolocateControl({ 
            positionOptions: { enableHighAccuracy: true }, 
            trackUserLocation: false,
            showAccuracyCircle: false
          }), controlPosition);
        }
      }
    });

    // Valida√ß√£o de endere√ßos em tempo real
    function validarEndereco(input, tipo) {
      const valor = input.value.trim();
      if(valor.length < 3) return;
      
      // Visual feedback durante digita√ß√£o
      input.style.borderColor = '#ffa500'; // Laranja para "buscando"
      
      setTimeout(() => {
        if(input.value === valor) { // Se ainda √© o mesmo texto
          input.style.borderColor = ''; // Volta ao normal
        }
      }, 1000);
    }
    
    $("#origem").addEventListener("input", e => validarEndereco(e.target, "origem"));
    $("#destino").addEventListener("input", e => validarEndereco(e.target, "destino"));

    // Limpeza das coordenadas quando texto muda (j√° existia, mantendo)
    $("#origem").addEventListener("change",()=>{ origemCoords=null; origemContexto=null; });
    $("#destino").addEventListener("change",()=>{ destinoCoords=null; destinoContexto=null; });
  </script>
</body>
</html>
